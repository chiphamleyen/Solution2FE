import React, { useState, useEffect } from 'react';
import { Card } from 'react-bootstrap';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer
} from 'recharts';
import { COLORS } from './ChartColors';
import { format, subDays } from 'date-fns';
import axiosUser from '../../../api/axiosUser';
import { API_PATHS_USER } from '../../../api/config';

const MalwareVsBenignChart = () => {
  const [chartData, setChartData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    const fetchDailyData = async () => {
      try {
        const last7Days = [];
        
        // Fetch data for each of the last 7 days
        for (let i = 6; i >= 0; i--) {
          const targetDate = subDays(new Date(), i);
          const yesterday = format(subDays(targetDate, 1), 'yyyy-MM-dd');
          const today = format(targetDate, 'yyyy-MM-dd');
          
          // Fetch data using yesterday and today for each day
          const response = await axiosUser.get(
            `${API_PATHS_USER.REPORT.split('?')[0]}?min_date=${yesterday}&max_date=${today}`
          );

          if (response.data.error_code === 0) {
            const dayData = response.data.data;
            
            // Calculate malware total (sum of all non-Benign traffic)
            const malwareTotal = dayData.classifier
              .filter(item => item.type !== "Benign")
              .reduce((sum, item) => sum + item.total, 0);

            // Get benign traffic count
            const benignCount = dayData.classifier
              .find(item => item.type === "Benign")?.total || 0;

            console.log(malwareTotal, benignCount);

            // Add the day's data to our array
            last7Days.push({
              date: format(targetDate, 'MMM dd'),
              Malware: malwareTotal,
              Benign: benignCount
            });
          }
        }
        
        // Update chart data with all 7 days
        setChartData(last7Days);
        setError(null);
      } catch (error) {
        console.error("Error fetching daily data:", error);
        setError("Failed to load traffic data");
      } finally {
        setLoading(false);
      }
    };

    fetchDailyData();
  }, []);

  if (loading) {
    return (
      <Card className="border-0 shadow-sm">
        <Card.Body className="d-flex justify-content-center align-items-center" style={{ height: "470px" }}>
          <div className="spinner-border text-primary" role="status">
            <span className="visually-hidden">Loading...</span>
          </div>
        </Card.Body>
      </Card>
    );
  }

  if (error) {
    return (
      <Card className="border-0 shadow-sm">
        <Card.Body className="d-flex justify-content-center align-items-center" style={{ height: "470px" }}>
          <div className="text-danger">{error}</div>
        </Card.Body>
      </Card>
    );
  }

  return (
    <Card className="border-0 shadow-sm">
      <Card.Body>
        <h5 className="card-title mb-4" style={{ color: "#475569" }}>Traffic Distribution (Last 7 Days)</h5>
        <ResponsiveContainer width="100%" height={470}>
          <BarChart
            data={chartData}
            margin={{ top: 20, right: 30, left: 20, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
            <XAxis 
              dataKey="date" 
              tick={{ fill: '#64748b' }}
              axisLine={{ stroke: '#cbd5e1' }}
            />
            <YAxis 
              tick={{ fill: '#64748b' }}
              axisLine={{ stroke: '#cbd5e1' }}
            />
            <Tooltip 
              contentStyle={{ 
                backgroundColor: '#ffffff',
                border: '1px solid #e2e8f0',
                borderRadius: '6px'
              }}
            />
            <Legend />
            <Bar 
              dataKey="Malware" 
              fill={COLORS.malware}
              radius={[4, 4, 0, 0]}
            />
            <Bar 
              dataKey="Benign" 
              fill={COLORS.benign}
              radius={[4, 4, 0, 0]}
            />
          </BarChart>
        </ResponsiveContainer>
      </Card.Body>
    </Card>
  );
};

export default MalwareVsBenignChart; 